name: Weekly Indeed Scraper (Hosted Runner Compatible)

on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

jobs:
  scrape-indeed:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium webdriver-manager

      - name: Install Chrome & ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -fy install
          google-chrome --version
          wget https://chromedriver.storage.googleapis.com/$(curl -sS chromedriver.storage.googleapis.com/LATEST_RELEASE)/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          chromedriver --version

      - name: Run Indeed scraper
        env:
          PYTHONUNBUFFERED: 1
        run: |
          python - <<'EOF'
          from selenium import webdriver
          from selenium.webdriver.chrome.service import Service
          from selenium.webdriver.chrome.options import Options
          from indeed_full_details_scraper import IndeedFullDetailsScraper
          from datetime import datetime

          print("ðŸš€ Running Indeed Scraper in Headless Mode...")

          # Force Selenium to use normal ChromeDriver
          options = Options()
          options.add_argument("--headless=new")
          options.add_argument("--no-sandbox")
          options.add_argument("--disable-dev-shm-usage")
          options.add_argument("--window-size=1920,1080")

          # Monkey-patch to skip undetected-chromedriver
          import indeed_full_details_scraper
          indeed_full_details_scraper.uc.Chrome = lambda options=None: webdriver.Chrome(options=options)

          scraper = IndeedFullDetailsScraper(headless=True)
          jobs = scraper.scrape_jobs("https://cr.indeed.com/jobs?q=&l=costa+rica", max_pages=3, extract_full_details=True)

          timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
          csv_file = f'indeed_cr_jobs_{timestamp}.csv'
          json_file = f'indeed_cr_jobs_{timestamp}.json'

          scraper.save_to_csv(jobs, csv_file)
          scraper.save_to_json(jobs, json_file)
          scraper.close()
          print("âœ… Scraping complete!")
          EOF

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: indeed-scraped-data
          path: |
            *.csv
            *.json

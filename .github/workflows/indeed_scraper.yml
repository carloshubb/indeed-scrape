name: Weekly Indeed Scraper (Self-Hosted + Undetected ChromeDriver)

on:
  schedule:
    - cron: "0 0 * * 1"  # Every Monday at 00:00 UTC
  workflow_dispatch:

jobs:
  scrape-indeed:
    runs-on: self-hosted  # IMPORTANT: run on your own machine (Windows/Linux)
    timeout-minutes: 2

    steps:
      # 1Ô∏è‚É£ Checkout your repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium undetected-chromedriver webdriver-manager

      # 4Ô∏è‚É£ Run the Indeed scraper
      - name: Run Indeed scraper (Headless)
        env:
          PYTHONUNBUFFERED: 1
        run: |
          python - <<'EOF'
          from indeed_full_details_scraper import IndeedFullDetailsScraper
          from datetime import datetime

          print("üöÄ Starting Indeed Scraper (self-hosted, undetected Chrome)...")

          search_url = "https://cr.indeed.com/jobs?q=&l=costa+rica"
          scraper = IndeedFullDetailsScraper(headless=True)  # Headless Chrome for CI

          jobs = scraper.scrape_jobs(
              search_url=search_url,
              max_pages=3,
              max_jobs=None,
              extract_full_details=True
          )

          if jobs:
              timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
              csv_file = f'indeed_cr_jobs_{timestamp}.csv'
              json_file = f'indeed_cr_jobs_{timestamp}.json'

              scraper.save_to_csv(jobs, csv_file)
              scraper.save_to_json(jobs, json_file)
              print(f"‚úÖ Scraped {len(jobs)} jobs successfully!")
          else:
              print("‚ö†Ô∏è No jobs scraped.")

          scraper.close()
          EOF

      # 5Ô∏è‚É£ Upload scraped results
      - name: Upload scraped data
        uses: actions/upload-artifact@v4
        with:
          name: indeed-scraped-data
          path: |
            *.csv
            *.json

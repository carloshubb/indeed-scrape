name: Weekly Indeed Scraper

on:
  schedule:
    - cron: "0 0 * * 1"  # Every Monday at 00:00 UTC
  workflow_dispatch:

jobs:
  scrape-indeed:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3Ô∏è‚É£ Install dependencies (including undetected-chromedriver)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium undetected-chromedriver webdriver-manager

      # 4Ô∏è‚É£ Install Google Chrome and ChromeDriver
      - name: Install Google Chrome and ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip xvfb
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get -fy install
          google-chrome --version

          # Match ChromeDriver version
          CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f3 | cut -d '.' -f1)
          DRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_$CHROME_VERSION")
          wget -q "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${DRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          unzip chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          chromedriver --version

      # 5Ô∏è‚É£ Run Indeed Scraper
      - name: Run Indeed scraper
        env:
          PYTHONUNBUFFERED: 1
        run: |
          python - <<'EOF'
          import os
          from indeed_full_details_scraper import IndeedFullDetailsScraper
          from datetime import datetime

          print("üöÄ Running Indeed Scraper (Hosted Runner + undetected-chromedriver)")

          search_url = "https://cr.indeed.com/jobs?q=&l=costa+rica"

          scraper = IndeedFullDetailsScraper(headless=True)
          jobs = scraper.scrape_jobs(search_url, max_pages=2, extract_full_details=True)

          if not jobs:
              print("‚ö†Ô∏è No jobs scraped.")
              exit(1)

          timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
          csv_file = f'indeed_cr_jobs_{timestamp}.csv'
          json_file = f'indeed_cr_jobs_{timestamp}.json'

          scraper.save_to_csv(jobs, csv_file)
          scraper.save_to_json(jobs, json_file)
          scraper.close()

          print(f"‚úÖ Scraping complete! Files saved: {csv_file}, {json_file}")
          EOF

      # 6Ô∏è‚É£ Upload Results
      - name: Upload scraped data
        uses: actions/upload-artifact@v4
        with:
          name: indeed-scraped-data
          path: |
            *.csv
            *.json
